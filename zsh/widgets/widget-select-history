#!/bin/zsh


# Paste the selected command from history into the command line.
function widget-select-history() {
    setopt local_options no_glob_subst pipe_fail 2> /dev/null
    local -a fzf_options
    fzf_options=(
      --height=40%
      --tac
      --nth='2..,..'
      --tiebreak=index
      --bind=ctrl-r:toggle-sort
      --reverse
      --query=${LBUFFER}
      +m
    )

    local -a selected
    selected=( $(fc -l 1 | $FZF_COMMAND $fzf_options[@]) )
    local exit_code=$?
    if [[ -n "$selected" ]]; then
      local num=$selected[1]
      if [[ -n $num ]]; then
        zle vi-fetch-history -n $num
      fi
    fi
    zle redisplay
    typeset -f zle-line-init >/dev/null && zle zle-line-init
    return $exit_code
}
