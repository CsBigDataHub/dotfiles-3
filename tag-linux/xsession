#!/bin/sh

command-is-available() {
    command -v "$1" &>/dev/null
}

run-in-fg-if-available() {
    command-is-available "$1" && $@
}

run-in-bg-if-available() {
    command-is-available "$1" && $@ &
}

# necessary to make chrome pick up the proxy settings stored in gconf.
export DESKTOP_SESSION=gnome

# Key bindings
if [[ -f $HOME/.xmodmaprc ]]; then
    /usr/bin/xmodmap $HOME/.xmodmaprc
fi

# Load .Xresources
if [[ -f "${HOME}/.Xresources" ]]; then
    xrdb -merge "${HOME}/.Xresources" &
fi

export OOO_FORCE_DESKTOP=gnome
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export LANGUAGE="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"

# So i3 uses st instead of gnome-terminal
export TERMINAL="st"

run-in-bg-if-available xbindkeys

# Google drive
if [[ -x /opt/google/drive/drive-launcher.sh ]]; then
    /opt/google/drive/drive-launcher.sh &
fi

# Don't run in background, it's already daemonized
run-in-fg-if-available insync start

# Ensure font-dir gets picked up.
if [[ -d "${HOME}/.local/share/fonts" ]]; then
    xset -fp "${HOME}/.local/share/fonts"
fi

run-in-bg-if-available volumeicon

# Startup terminal
command-is-available st > /dev/null && st -e "tmux new-session -A -s main"

# Start emacs
if [[ -x /usr/bin/google-emacs ]]; then
    google-emacs &
elif [[ -x /usr/bin/emacs ]]; then
    emacs &
fi

# Enable zapping
# setxkbmap -option terminate:ctrl_alt_bksp

# Hide the cursor until it's moved
# if unclutter -v = "unclutter-xfixes*" > /dev/null; then
#     unclutter --exclude-root --jitter 10 &
# else
#     unclutter -jitter 10 &
# fi

run-in-bg-if-available compton --config ~/.config/compton/compton.conf

run-in-bg-if-available gtk-redshift -l 37.638:-122.387

# Don't run in background, it's already daemonized
run-in-fg-if-available nitrogen --restore

if [[ -f "${HOME}/.xsession-system" ]]; then
    . "${HOME}/.xsession-system"
fi

# Start the window manager
exec i3
